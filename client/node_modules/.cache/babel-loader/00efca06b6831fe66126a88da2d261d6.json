{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\n\nvar key = require('interface-datastore/key');\n\nvar errors = require('datastore-core/errors');\n\nconst CONFIG_KEY = new key.Key('/config');\nconst VERSION_KEY = new key.Key('/version');\n\nfunction findLevelJs(store) {\n  let db = store;\n\n  while (db.db || db.child) {\n    db = db.db || db.child;\n\n    if (db.type === 'level-js' || db.constructor.name === 'Level') {\n      return db;\n    }\n  }\n}\n\nasync function hasWithFallback(key, has, store) {\n  const result = await has(key);\n\n  if (result) {\n    return result;\n  }\n\n  const levelJs = findLevelJs(store);\n\n  if (!levelJs) {\n    return false;\n  }\n\n  return new Promise((resolve, reject) => {\n    const req = levelJs.store('readonly').get(key.toString());\n\n    req.transaction.onabort = () => {\n      reject(req.transaction.error);\n    };\n\n    req.transaction.oncomplete = () => {\n      resolve(Boolean(req.result));\n    };\n  });\n}\n\nasync function getWithFallback(key, get, has, store) {\n  if (await has(key)) {\n    return get(key);\n  }\n\n  const levelJs = findLevelJs(store);\n\n  if (!levelJs) {\n    throw errors.notFoundError();\n  }\n\n  return new Promise((resolve, reject) => {\n    const req = levelJs.store('readonly').get(key.toString());\n\n    req.transaction.onabort = () => {\n      reject(req.transaction.error);\n    };\n\n    req.transaction.oncomplete = () => {\n      if (req.result) {\n        return resolve(req.result);\n      }\n\n      reject(errors.notFoundError());\n    };\n  });\n}\n\nfunction wrapStore(store) {\n  const originalGet = store.get.bind(store);\n  const originalHas = store.has.bind(store);\n\n  store.get = key => getWithFallback(key, originalGet, originalHas, store);\n\n  store.has = key => hasWithFallback(key, originalHas, store);\n\n  return store;\n}\n\nfunction wrapBackends(backends) {\n  return { ...backends,\n    root: wrapStore(backends.root),\n    datastore: wrapStore(backends.datastore),\n    pins: wrapStore(backends.pins),\n    keys: wrapStore(backends.keys)\n  };\n}\n\nexports.CONFIG_KEY = CONFIG_KEY;\nexports.VERSION_KEY = VERSION_KEY;\nexports.findLevelJs = findLevelJs;\nexports.hasWithFallback = hasWithFallback;\nexports.wrapBackends = wrapBackends;","map":{"version":3,"sources":["/Users/emilsharafutdinov/Desktop/Work/SR3/Wrdl3/client/node_modules/ipfs-repo-migrations/cjs/src/utils.js"],"names":["Object","defineProperty","exports","value","key","require","errors","CONFIG_KEY","Key","VERSION_KEY","findLevelJs","store","db","child","type","constructor","name","hasWithFallback","has","result","levelJs","Promise","resolve","reject","req","get","toString","transaction","onabort","error","oncomplete","Boolean","getWithFallback","notFoundError","wrapStore","originalGet","bind","originalHas","wrapBackends","backends","root","datastore","pins","keys"],"mappings":"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","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\nvar key = require('interface-datastore/key');\nvar errors = require('datastore-core/errors');\n\nconst CONFIG_KEY = new key.Key('/config');\nconst VERSION_KEY = new key.Key('/version');\nfunction findLevelJs(store) {\n  let db = store;\n  while (db.db || db.child) {\n    db = db.db || db.child;\n    if (db.type === 'level-js' || db.constructor.name === 'Level') {\n      return db;\n    }\n  }\n}\nasync function hasWithFallback(key, has, store) {\n  const result = await has(key);\n  if (result) {\n    return result;\n  }\n  const levelJs = findLevelJs(store);\n  if (!levelJs) {\n    return false;\n  }\n  return new Promise((resolve, reject) => {\n    const req = levelJs.store('readonly').get(key.toString());\n    req.transaction.onabort = () => {\n      reject(req.transaction.error);\n    };\n    req.transaction.oncomplete = () => {\n      resolve(Boolean(req.result));\n    };\n  });\n}\nasync function getWithFallback(key, get, has, store) {\n  if (await has(key)) {\n    return get(key);\n  }\n  const levelJs = findLevelJs(store);\n  if (!levelJs) {\n    throw errors.notFoundError();\n  }\n  return new Promise((resolve, reject) => {\n    const req = levelJs.store('readonly').get(key.toString());\n    req.transaction.onabort = () => {\n      reject(req.transaction.error);\n    };\n    req.transaction.oncomplete = () => {\n      if (req.result) {\n        return resolve(req.result);\n      }\n      reject(errors.notFoundError());\n    };\n  });\n}\nfunction wrapStore(store) {\n  const originalGet = store.get.bind(store);\n  const originalHas = store.has.bind(store);\n  store.get = key => getWithFallback(key, originalGet, originalHas, store);\n  store.has = key => hasWithFallback(key, originalHas, store);\n  return store;\n}\nfunction wrapBackends(backends) {\n  return {\n    ...backends,\n    root: wrapStore(backends.root),\n    datastore: wrapStore(backends.datastore),\n    pins: wrapStore(backends.pins),\n    keys: wrapStore(backends.keys)\n  };\n}\n\nexports.CONFIG_KEY = CONFIG_KEY;\nexports.VERSION_KEY = VERSION_KEY;\nexports.findLevelJs = findLevelJs;\nexports.hasWithFallback = hasWithFallback;\nexports.wrapBackends = wrapBackends;\n"]},"metadata":{},"sourceType":"script"}